<!DOCTYPE html>
<html>

<head>
    <title>Real-Time Order Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #0a0a0f;
            color: #0f0;
        }

        h1 {
            color: #8B5CF6;
        }

        .status {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
        }

        .warning {
            color: #ff0;
        }

        button {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        pre {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: scroll;
        }
    </style>
</head>

<body>
    <h1>üîç Real-Time Order Debugging</h1>

    <div class="status">
        <h3>Step 1: Check Login Status</h3>
        <div id="loginStatus">Checking...</div>
    </div>

    <div class="status">
        <h3>Step 2: Check Order Data</h3>
        <div id="orderStatus">Checking...</div>
    </div>

    <div class="status">
        <h3>Step 3: Test API Connection</h3>
        <button onclick="testAPI()">Test API</button>
        <div id="apiStatus">Click button to test...</div>
    </div>

    <div class="status">
        <h3>Step 4: Complete Real Order</h3>
        <button onclick="completeOrder()">Complete Order NOW</button>
        <div id="completeStatus">Click button when ready...</div>
    </div>

    <div class="status">
        <h3>Live Logs:</h3>
        <pre id="logs">Logs will appear here...</pre>
    </div>

    <script src="modal-system.js"></script>
    <script src="api-client.js"></script>

    <script>
        const logs = document.getElementById('logs');

        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${msg}\n`;
            logs.textContent += line;
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }

        // Step 1: Check login
        function checkLogin() {
            const user = window.api.getCurrentUser();
            const el = document.getElementById('loginStatus');

            if (user) {
                el.className = 'success';
                el.innerHTML = `‚úÖ Logged in as: <strong>${user.username}</strong><br>Profile ID: ${user.id}`;
                log('‚úÖ User logged in: ' + user.username);
                return user;
            } else {
                el.className = 'error';
                el.innerHTML = '‚ùå NOT LOGGED IN! <a href="login.html">Login here</a>';
                log('‚ùå No user logged in');
                return null;
            }
        }

        // Step 2: Check order data
        function checkOrderData() {
            const orderData = sessionStorage.getItem('pendingOrder');
            const el = document.getElementById('orderStatus');

            if (orderData) {
                const order = JSON.parse(orderData);
                el.className = 'success';
                el.innerHTML = `‚úÖ Order found:<br><pre>${JSON.stringify(order, null, 2)}</pre>`;
                log('‚úÖ Pending order found');
                return order;
            } else {
                el.className = 'error';
                el.innerHTML = '‚ùå NO ORDER DATA! <a href="order.html">Create order here</a>';
                log('‚ùå No pending order in session');
                return null;
            }
        }

        // Step 3: Test API
        async function testAPI() {
            const el = document.getElementById('apiStatus');
            el.textContent = 'Testing...';
            log('üß™ Testing API connection...');

            try {
                const response = await fetch('http://localhost:3000/api/stats');
                const stats = await response.json();

                el.className = 'success';
                el.innerHTML = `‚úÖ API Working!<br>Total orders in DB: ${stats.totalOrders}`;
                log('‚úÖ API connection successful');
                log(`üìä Stats: ${stats.totalOrders} orders, ${stats.totalUsers} users`);
            } catch (error) {
                el.className = 'error';
                el.textContent = '‚ùå API Error: ' + error.message;
                log('‚ùå API error: ' + error.message);
            }
        }

        // Step 4: Complete order
        async function completeOrder() {
            const el = document.getElementById('completeStatus');
            el.textContent = 'Processing...';
            log('\nüöÄ Starting order completion...');

            try {
                // Check login
                const user = checkLogin();
                if (!user) {
                    el.className = 'error';
                    el.textContent = '‚ùå Please login first!';
                    return;
                }

                // Check order data
                const orderData = checkOrderData();
                if (!orderData) {
                    el.className = 'error';
                    el.textContent = '‚ùå Please create an order first!';
                    return;
                }

                // Create order object
                const order = {
                    orderId: 'ORD_' + Date.now(),
                    profileId: user.id,
                    username: orderData.username,
                    email: orderData.email,
                    whatsapp: orderData.whatsapp || '',
                    packageName: orderData.packageName,
                    followers: orderData.followers,
                    amount: orderData.amount,
                    status: 'pending_verification'
                };

                log('üì¶ Order object created: ' + order.orderId);
                log('User: ' + orderData.username);
                log('Package: ' + orderData.packageName);
                log('Amount: ‚Çπ' + orderData.amount);

                // Save to API
                log('üì§ Sending to API...');
                const result = await window.api.createOrder(order);

                log('‚úÖ API Response: ' + JSON.stringify(result));

                // Verify it saved
                log('üîç Verifying order in database...');
                const allOrders = await fetch('http://localhost:3000/api/orders').then(r => r.json());
                const savedOrder = allOrders.find(o => o.orderId === order.orderId);

                if (savedOrder) {
                    el.className = 'success';
                    el.innerHTML = `‚úÖ SUCCESS! Order ${order.orderId} saved to database!<br><br>Check admin panel now!`;
                    log('‚úÖ ORDER CONFIRMED IN DATABASE!');
                    log('Order details: ' + JSON.stringify(savedOrder, null, 2));

                    await window.modal.success(
                        `Order ${order.orderId} saved successfully! Check admin panel.`,
                        'Success! üéâ'
                    );

                    // Clear pending order
                    sessionStorage.removeItem('pendingOrder');
                } else {
                    el.className = 'error';
                    el.textContent = '‚ùå Order not found in database after save!';
                    log('‚ùå Order not in database!');
                }

            } catch (error) {
                el.className = 'error';
                el.textContent = '‚ùå Error: ' + error.message;
                log('‚ùå ERROR: ' + error.message);
                log('Stack: ' + error.stack);
            }
        }

        // Auto-check on load
        window.onload = () => {
            log('üîç Auto-checking status...');
            checkLogin();
            checkOrderData();
        };
    </script>
</body>

</html>